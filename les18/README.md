# Контейнеризация Spring приложений. Docker

## Контейнеризация

Контейнеризация — это технология упаковки приложения и всех его зависимостей в единый исполняемый образ, который может одинаково запускаться в любой среде. Она обеспечивает изоляцию, переносимость и масштабируемость приложений.

### Основные технологии контейнеризации

| Технология     | Описание |
|----------------|----------|
| **Docker**     | Самая популярная платформа для создания, развертывания и управления контейнерами. Использует образы и контейнеры. |
| **Podman**     | Альтернатива Docker без демона. Лучше интегрируется с системой безопасности Linux. Совместим с Docker CLI. |
| **containerd** | Низкоуровневый контейнерный рантайм, используемый в Docker и Kubernetes. |
| **CRI-O**      | Контейнерный рантайм, соответствующий интерфейсу Kubernetes CRI. Легковесный и безопасный. |
| **LXC/LXD**    | Контейнеризация на уровне операционной системы. LXD — это управляющий инструмент для LXC с REST API. |

Технологии контейнеризации приложений нашли широкое применение в сферах разработки ПО и анализа данных. Эти технологии помогают сделать приложения более безопасными, облегчают их развёртывание и улучшают возможности по их масштабированию. Рост и развитие технологий контейнеризации можно считать одним из важнейших трендов современности.

### Отличие контейнеризации от виртуализации

| Критерий                   | Контейнеризация                              | Виртуализация                                 |
|----------------------------|-----------------------------------------------|-----------------------------------------------|
| **Уровень абстракции**     | Операционная система                         | Аппаратное обеспечение                         |
| **Запускаемая среда**      | Приложение + библиотеки                      | Полноценная ОС с ядром                         |
| **Изоляция**               | Через namespaces и cgroups                   | Через гипервизор (жёсткая изоляция)            |
| **Производительность**     | Почти нативная, без накладных расходов       | Снижается из-за гипервизора и ОС               |
| **Время запуска**          | Очень быстро (миллисекунды)                  | Долго (секунды и более)                        |
| **Объём ресурсов**         | Лёгкие, используют меньше CPU и памяти       | Тяжёлые, дублируют ресурсы                     |
| **Совместное ядро**        | Да (контейнеры используют ядро хоста)        | Нет (у каждой ВМ — своё ядро)                 |
| **Примеры технологий**     | Docker, Podman, LXC                          | VMware, VirtualBox, Hyper-V, KVM              |
| **Основное применение**    | Микросервисы, DevOps, CI/CD, облака          | Тестирование ОС, запуск монолитов, legacy     |

+ Контейнеризация — изоляция на уровне приложений.
+ Виртуализация — изоляция на уровне ОС и железа.

## Обзор Docker

Docker — это платформа, которая предназначена для разработки, развёртывания и запуска приложений в контейнерах. Слово «Docker» в последнее время стало чем-то вроде синонима слова «контейнеризация». И если вы ещё не пользуетесь Docker, но при этом работаете или собираетесь работать в сферах разработки приложений или анализа данных, то Docker — это то, с чем вы непременно встретитесь в будущем.

<img src="./assets/docker-logo-blue.png" width=400>

### Экосистема Docker

#### Платформа Docker

Платформа Docker (Docker Platform) — это программа, которая даёт нам возможность упаковывать приложения в контейнеры и запускать их на серверах. Платформа Docker позволяет помещать в контейнеры код и его зависимости. Как результат, системы, основанные на контейнерах, легко масштабировать, так как контейнеры можно переносить и воспроизводить.

+ Компоненты платформы Docker

| Компонент           | Назначение |
|---------------------|------------|
| **Docker Engine**   | Основной движок, который запускает и управляет контейнерами. Включает клиент, демон и API. |
| **Docker CLI**      | Командная строка (`docker`), позволяющая управлять образами, контейнерами, сетями, томами и т.д. |
| **Docker API**      | REST API для программного управления Docker (в том числе удалённо). |
| **Docker Hub**      | Облачный реестр образов. Позволяет хранить и загружать Docker-образы. |
| **Docker Compose**  | Инструмент для описания и запуска многоконтейнерных приложений с помощью YAML-файлов. |
| **Docker Desktop**  | Графическая среда (для Windows и macOS) с локальным Docker Engine и дополнительными инструментами. |
| **Docker BuildKit** | Улучшенный движок сборки образов: быстрее, безопаснее, поддерживает кэширование и параллелизм. |

#### Движок Docker

Движок Docker (Docker Engine) — это клиент-серверное приложение. Компания Docker разделила движок Docker на два продукта. Docker Community Edition (CE) — это бесплатное ПО, во многом основанное на опенсорсных инструментах.

Вероятно, вы будете пользоваться именно этой версией Docker. Docker Enterprise — это платная версия системы, дающая пользователям дополнительные возможности в области поддержки систем, управления ими и безопасности. Платная версия Docker даёт компании средства, необходимые для её существования.

#### Клиент Docker

Клиент Docker (Docker Client) — это основное средство, которое используют для взаимодействия с Docker. Так, при работе с интерфейсом командной строки Docker (Docker Command Line Interface, CLI), в терминал вводят команды, начинающиеся с ключевого слова docker, обращаясь к клиенту. Затем клиент использует API Docker для отправки команд демону Docker.

<image src="./assets/arch.png" width=800>

#### Демон Docker

Демон Docker (Docker Daemon) — это сервер Docker, который ожидает запросов к API Docker. Демон Docker управляет образами, контейнерами, сетями и томами.

#### Архитектура Docker

Архитектура Docker основана на клиент-серверной модели, где клиент взаимодействует с демоном (сервером), который управляет контейнерами:

| Компонент          | Роль и описание |
|--------------------|-----------------|
| **Docker Client**  | CLI-интерфейс (`docker` команда), через который пользователь отправляет команды (например, `docker build`, `docker run`) демону. |
| **Docker Daemon (dockerd)** | Сервер, который слушает Docker API-запросы, управляет образами, контейнерами, томами и сетями. |
| **Docker REST API** | Интерфейс взаимодействия между клиентом и демоном. Поддерживает удалённый доступ к Docker Daemon. |

### Концепции Docker

#### Образ контейнера Docker

То что в терминологии Docker называется «образом», или, по-английски, «image». Образы контейнеров Docker можно сравнить с чертежами, с формочками для печенья, или с пресс-формами для изготовления пластиковых изделий. Образы — это неизменные шаблоны, которые используются для создания одинаковых контейнеров. В образе контейнера Docker содержится образ базовой операционной системы, код приложения, библиотеки, от которого оно зависит. Всё это скомпоновано в виде единой сущности, на основе которой можно создать контейнер.

#### Файл Dockerfile

Файл Dockerfile содержит набор инструкций, следуя которым Docker будет собирать образ контейнера. Этот файл содержит описание базового образа, который будет представлять собой исходный слой образа. Среди популярных официальных базовых образов можно отметить python, ubuntu, alpine.

В образ контейнера, поверх базового образа, можно добавлять дополнительные слои. Делается это в соответствии с инструкциями из Dockerfile. Например, если Dockerfile описывает образ, который планируется использовать для решения задач машинного обучения, то в нём могут быть инструкции для включения в промежуточный слой такого образа библиотек NumPy, Pandas и Scikit-learn.

И, наконец, в образе может содержаться, поверх всех остальных, ещё один тонкий слой, данные, хранящиеся в котором, поддаются изменению. Это — небольшой по объёму слой, содержащий программу, которую планируется запускать в контейнере.

#### Контейнер Docker

Контейнер Docker — это изолированная среда для запуска приложения, которая включает в себя всё необходимое: код, библиотеки, зависимости и настройки.
Для того чтобы запустить контейнер, нам нужен, во-первых, образ контейнера, во-вторых — среда, в которой установлен Docker, способная понять команду вида docker run image_name. Эта команда создаёт контейнер из образа и запускает его.

#### Репозиторий контейнеров

Если вы хотите дать возможность другим людям создавать контейнеры на основе вашего образа, вы можете отправить этот образ в облачное хранилище. Самым крупным подобным хранилищем является репозиторий Docker Hub. Он используется при работе с Docker по умолчанию.

#### Тома (Volumes) в Docker

Тома (Volumes) в Docker — это механизм для постоянного хранения данных, которые не исчезают при перезапуске или удалении контейнера. Они особенно полезны для баз данных, логов и конфигураций.

#### Cети (networks) в Docker

В Docker сети (networks) — это способ организации взаимодействия между контейнерами. Сети позволяют контейнерам находить друг друга по имени, ограничивать доступ и конфигурировать связи между сервисами.

## Установка Docker с помощью Docker Desktop

## Шаги установки Docker Desktop

| Шаг | Действие |
|-----|----------|
| 1️  | Перейди на официальный сайт: https://www.docker.com/products/docker-desktop |
| 2️  | Нажми **Download for Windows/macOS** — загрузится установщик |
| 3️  | Запусти установочный файл и следуй инструкциям |
| 4️  | После установки — перезагрузи систему (если потребуется) |
| 5️  | Открой **Docker Desktop** — он автоматически запустит Docker Engine |
| 6️  | Проверь, что всё работает: открой терминал и введи `docker --version` |


``` bash
docker --version
docker run hello-world
```

## Основные команды Docker

| Категория          | Команда                                  | Назначение |
|--------------------|-------------------------------------------|------------|
| Проверка        | `docker --version`                        | Показать версию Docker |
|                    | `docker info`                             | Общая информация о Docker |
| Образы          | `docker images`                           | Список локальных образов |
|                    | `docker pull <имя>`                       | Скачать образ из Docker Hub |
|                    | `docker build -t <имя> .`                 | Собрать образ из Dockerfile |
|                    | `docker rmi <id/имя>`                     | Удалить образ |
| Контейнеры       | `docker ps`                               | Список запущенных контейнеров |
|                    | `docker ps -a`                            | Список всех контейнеров |
|                    | `docker run <опции> <образ>`             | Запустить контейнер |
|                    | `docker start <id/имя>`                   | Запустить остановленный контейнер |
|                    | `docker stop <id/имя>`                    | Остановить контейнер |
|                    | `docker restart <id/имя>`                 | Перезапустить контейнер |
|                    | `docker rm <id/имя>`                      | Удалить контейнер |
| Управление       | `docker exec -it <контейнер> bash`       | Войти внутрь работающего контейнера |
|                    | `docker logs <контейнер>`                 | Просмотр логов |
| Том/Сеть         | `docker volume ls`                        | Список томов |
|                    | `docker network ls`                       | Список сетей |
| Тест             | `docker run hello-world`                 | Проверка работы Docker |

``` bash

docker run debian echo "Hello World"
docker run -h CONTAINER -i -t debian /bin/bash
docker ps 
docker inspect admiring_swanson
docker inspect --format {{.NetworkSettings.IPAddress}} admiring_swanson
docker start admiring_swanson

```

## Создание Docker-образа

Создание Docker-образа — это процесс упаковки вашего приложения и его зависимостей в единый исполняемый образ, который можно запускать как контейнер. Ниже — подробная инструкция.

Docker-образ — это шаблон, из которого создаются контейнеры. Он включает в себя всё, что нужно для запуска приложения:

+ код,
+ зависимости,
+ системные библиотеки,
+ команды запуска.

### Пошаговая инструкция

| Шаг | Действие |
|-----|----------|
| 1️ | Установите Docker |
| 2️  | Создайте файл `Dockerfile` в корне проекта |
| 3️  | Опишите, как собирать образ (в Dockerfile) |
| 4️  | Выполните `docker build` для создания образа |
| 5️ | Проверьте, что образ создан — `docker images` |

Соберем Docker образ для работы с программой cowsay

+ Подготовка Dockerfile

Основные команды Dockerfile

| Команда         | Назначение |
|------------------|------------|
| `FROM`           | Базовый образ, с которого начинается сборка (например, `openjdk:17`, `node:20`) |
| `LABEL`          | Добавление метаданных (автор, версия и т.п.) |
| `WORKDIR`        | Установка рабочей директории внутри контейнера |
| `COPY`           | Копирование файлов с хоста внутрь контейнера |
| `ADD`            | То же, что `COPY`, но ещё умеет распаковывать архивы и загружать по URL |
| `RUN`            | Выполнение команды во время сборки образа (например, установка зависимостей) |
| `CMD`            | Команда по умолчанию при запуске контейнера *(можно переопределить)* |
| `ENTRYPOINT`     | Основная команда, которую нельзя переопределить обычным `docker run` |
| `EXPOSE`         | Описание порта, который будет использовать приложение (не открывает порт наружу!) |
| `ENV`            | Установка переменных окружения |
| `VOLUME`         | Объявление тома для хранения данных |
| `USER`           | Задание пользователя, от имени которого запускается процесс |
| `ARG`            | Объявление переменной сборки (используется с `--build-arg`) |
| `HEALTHCHECK`    | Проверка состояния контейнера (например, HTTP-запрос к `/health`) |
| `ONBUILD`        | Инструкция, которая сработает **в следующем** Dockerfile при использовании этого образа как базового |

```docker
FROM debian:bookworm

RUN apt-get update && apt-get install -y cowsay

COPY entrtypoint.sh /

RUN chmod +x  /entrtypoint.sh

ENTRYPOINT ["/entrtypoint.sh"]
```

+ Создание ENTRYPOINT

``` bash
#!/bin/bash

/usr/games/cowsay "$@"
```

+ Сборка образа
  
``` bash
docker build -t test/cowsay-dockerfile .

```

+ Проверка

``` bash
docker images
docker run test/cowsay-dockerfile "Hello"
```

## Создание Docker-образа для Spring Boot приложения

### Создание Docker-образ Spring Boot приложения "вручную"

| Шаг | Действие |
|-----|----------|
| 1️  | Собери JAR-файл с помощью `mvn clean package` или `gradle bootJar` |
| 2️  | Создай `Dockerfile` в корне проекта |
| 3️  | Собери образ с помощью `docker build` |
| 4️  | Запусти контейнер с помощью `docker run` |

Структура проекта

```text
springboot-app/
├── target/app.jar          # после сборки (Maven/Gradle)
├── Dockerfile
└── ... (src, pom.xml, т.д.)
```

Пример Dockerfile

``` docker
# Используем официальный образ Java
FROM openjdk:17-jdk-slim

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем JAR-файл в контейнер
COPY target/*.jar app.jar

# Открываем порт (если приложение слушает, например, 8080)
EXPOSE 8080

# Указываем команду запуска
ENTRYPOINT ["java", "-jar", "app.jar"]
```

Сборка и запуск

+ Сборка JAR
``` bash
./mvnw clean package   # или gradle bootJar
```

+  Сборка Docker-образа
``` bash 
docker build -t springboot-app .
```

+ Запуск контейнера 
``` bash 
docker run -p 8080:8080 springboot-app
```

### Создание Docker-образ Spring Boot приложения с использованием Spring Boot Plugin 

Для Spring Boot с Gradle можно удобно собирать Docker-образы с помощью Spring Boot Plugin и его встроенной задачи bootBuildImage, которая использует Paketo Buildpacks. Это самый простой и официально поддерживаемый способ.

``` kotlin
plugins {
    id("org.springframework.boot") version "3.2.5" // или твоя версия
    id("io.spring.dependency-management") version "1.1.4"
    kotlin("jvm") version "1.9.23" // если используешь Kotlin
    kotlin("plugin.spring") version "1.9.23"
}

springBoot {
    buildImage {
        imageName.set("yourname/springboot-app") // имя образа
        environment.set(
            mapOf(
                "BP_JVM_VERSION" to "17" // указание версии JVM
            )
        )
    }
}
```

Сборка Docker-образа
``` bash 
./gradlew bootBuildImage
```

Результат:
+ Образ будет создан без Dockerfile
+ Используются Paketo Buildpacks (официальные)
+ Не нужен установленный Dockerfile

Запуск собранного образа

``` bash
docker run -p 8080:8080 yourname/springboot-app
```

## Docker том (volume)

| Свойство             | Описание |
|----------------------|----------|
| **Назначение**       | Хранение данных вне контейнера |
| **Персистентность**  | Сохраняются при пересоздании контейнеров |
| **Разделение**       | Могут использоваться несколькими контейнерами |
| **Управление**       | Через команды `docker volume` |
| **Хранение**         | На файловой системе хоста в `/var/lib/docker/volumes/` (Linux) |


Основные команды Docker для томов

| Команда                                     | Назначение |
|--------------------------------------------|------------|
| `docker volume create my-volume`           | Создать том |
| `docker volume ls`                         | Список томов |
| `docker volume inspect my-volume`          | Подробности о томе |
| `docker volume rm my-volume`               | Удалить том |
| `docker volume prune`                      | Удалить все неиспользуемые тома |

Использование 

Это подключит том my-volume к каталогу /app/data внутри контейнера.

```bash
docker run -d \
  --name my-container \
  -v my-volume:/app/data \
  my-image
```

Пример

``` bash 
docker run -d \
  --name pg \
  -e POSTGRES_PASSWORD=secret \
  -v pgdata:/var/lib/postgresql/data \
  postgres
```

## Сети
В Docker сети (networks) — это способ организации взаимодействия между контейнерами. Сети позволяют контейнерам находить друг друга по имени, ограничивать доступ и конфигурировать связи между сервисами.

Основы Docker-сетей

| Характеристика      | Описание |
|----------------------|----------|
| **Изоляция**         | Контейнеры в одной сети могут общаться, в разных — нет (по умолчанию) |
| **DNS по имени**     | Контейнеры могут обращаться друг к другу по имени (если в одной сети) |
| **Типы сетей**       | bridge, host, none, overlay (для Docker Swarm), custom |
| **Гибкость**         | Можно создавать свои изолированные сети и подключать контейнеры к ним |

Основные команды Docker-сетей

| Команда                                  | Назначение |
|------------------------------------------|------------|
| `docker network ls`                      | Список всех сетей |
| `docker network create my-net`           | Создать пользовательскую сеть |
| `docker network inspect my-net`          | Посмотреть детали сети |
| `docker network rm my-net`               | Удалить сеть |
| `docker run --network=my-net ...`        | Подключить контейнер к сети при запуске |
| `docker network connect my-net cont`     | Подключить уже запущенный контейнер к сети |
| `docker network disconnect my-net cont`  | Отключить контейнер от сети |

``` bash

docker network create my-net

docker run -d --name db --network=my-net postgres

docker run -d --name app --network=my-net myapp
```

## Docker Compose

r Compose — это инструмент, который позволяет описывать и запускать многоконтейнерные приложения с помощью одного YAML-файла (docker-compose.yml). Он значительно упрощает управление зависимостями (БД, кеш, брокеры и т.д.) и автоматизирует запуск всех сервисов сразу.

| Возможность                          | Польза |
|--------------------------------------|--------|
| Описывать многоконтейнерные приложения | Один файл для всех сервисов |
| Автоматически запускать все сервисы   | Не нужно вручную писать `docker run` для каждого |
| Управлять зависимостями (БД, кеш)     | Контейнеры стартуют в нужном порядке |
| Определять сети, тома, переменные     | Изоляция и настройка среды |
| Упрощать запуск для команды/разработчиков | Один `docker-compose up` и всё работает |


### Spring Boot + PostgreSQL через Docker Compose

```text
project/
├── src/
├── Dockerfile
├── docker-compose.yml
├── target/app.jar
└── application.yml
```

Dockerfile для Spring Boot

``` docker
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/app.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

docker-compose.yml

``` docker
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - db
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/mydb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: secret
    networks:
      - backend

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - backend

volumes:
  pgdata:

networks:
  backend:
    driver: bridge
```

Команды

``` bash 
docker-compose build      # Сборка образов
docker-compose up         # Запуск всех контейнеров
docker-compose down       # Остановка и удаление контейнеров/сети
```

## Dev Containers

Dev Containers — это подход к разработке, при котором среда (язык, зависимости, инструменты) разворачивается внутри Docker-контейнера. Это обеспечивает:
+	единообразие окружения для всех разработчиков,
+ изоляцию от хост-системы,
+ удобную интеграцию с VS Code (через расширение Dev Containers).
